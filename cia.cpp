////////////////////////////////////////////////////////////////////////////////
// cia.cpp
////////////////////////////////////////////////////////////////////////////////

#include "cia.h"
#include <hardware/cia.h>
#include <hardware/custom.h>
#include <hardware/intbits.h>
#include "core.h"
#include "system.h"

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
__attribute__((interrupt))
static void Irq6Handler()
{
	custom.intreq = INTF_EXTER;

	u8 pending = ciab.ciaicr;

	if (pending & CIAICRF_TA)
	{
		custom.color[0] = 0x0f0;
		custom.color[0] = 0x000;
	}
	else
	{
		custom.color[0] = 0xf00;
		custom.color[0] = 0x000;
	}
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
bool Cia_Init()
{
	System_WaitVbl();

	System_SetIrq6Handler(Irq6Handler);

	// Set up raster timer.
	ciab.ciacra = CIACRAF_RUNMODE;
	ciab.ciaicr = CIAICRF_SETCLR | CIAICRF_TA;
	ciab.ciatalo = 7000 & 255;

	// Wait for the top of the frame before starting.
	System_WaitVbl();

	// Enable the exter interrupts when still nearly at the top of the frame.
	custom.intena = INTF_SETCLR | INTF_INTEN | INTF_EXTER;

	return true;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void Cia_Deinit()
{
	custom.intena = INTF_EXTER | INTF_VERTB;

	System_WaitVbl();

	System_SetIrq6Handler(nullptr);
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void Cia_Update()
{
	System_WaitVbl();

	// Start raster timer.
	ciab.ciatahi = 7000 >> 8;
}
